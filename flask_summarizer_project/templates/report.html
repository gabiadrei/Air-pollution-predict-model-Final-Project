<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת איכות הסביבה - דוחות</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap');
        body{font-family:'Heebo',sans-serif;background-color:#F8F9FA;direction:rtl}
        .app-header{background-color:white;box-shadow:0 2px 4px rgba(0,0,0,.1);position:sticky;top:0;z-index:1000}
        .nav-link.active{background-color:#e6f6ec;color:#34C759;font-weight:500}
        #treesMap{height:500px;border-radius:.5rem;position:relative}
        .message-box,.modal-overlay,.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:2000}
        .message-box-content{background-color:#fff;padding:2rem;border-radius:1rem;box-shadow:0 10px 25px rgba(0,0,0,.2);text-align:center;direction:rtl}
        .modal-content{background-color:#fff;padding:2rem;border-radius:1rem;width:90%;max-width:1200px;max-height:90%;overflow:hidden;position:relative;display:flex;flex-direction:column}
        .modal-body{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem}
        @media (max-width:768px){.modal-body{grid-template-columns:1fr}}
        .map-modal-container{width:100%;height:400px;border-radius:.5rem}
        .gallery-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:.5rem;max-height:400px;overflow-y:auto;padding:.5rem;background-color:#f5f5f5;border-radius:.5rem}
        .gallery-container img{width:100%;height:auto;border-radius:.25rem;object-fit:cover;border:1px solid #ccc}
        .loading-spinner{border:4px solid rgba(255,255,255,.3);border-top:4px solid #fff;border-radius:50%;width:1.5rem;height:1.5rem;animation:spin 1s linear infinite}
        .loading-spinner-large{border:8px solid rgba(0,0,0,.2);border-top:8px solid #34C759;border-radius:50%;width:80px;height:80px;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        #map-controls{position:absolute;top:10px;right:10px;z-index:800}
        .map-filter-buttons{position:absolute;top:10px;left:10px;z-index:800;display:flex;gap:5px}
        .map-filter-buttons button{background-color:white;padding:8px 12px;border-radius:8px;font-weight:500;box-shadow:0 2px 5px rgba(0,0,0,.2);transition:background-color .2s;cursor:pointer; border: 1px solid #ccc;}
        .map-filter-buttons button.active,.map-filter-buttons button:hover{background-color:#34C759;color:white; border-color: #34C759;}
        .leaflet-tooltip {
            background-color: white !important;
            border: 1px solid #ccc !important;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4) !important;
            font-weight: bold !important;
            color: #333 !important;
            padding: 6px 10px !important;
            border-radius: 4px !important;
            text-shadow: none !important;
        }
        .tree-icon{text-shadow:1px 1px 3px rgba(0,0,0,.4);transition:all .2s ease-in-out; cursor: pointer;}
        .tree-icon:hover{transform:scale(1.2)}
        .chart-card {
            background-color: #eef2f5;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }
        .chart-card h3 {
            text-align: center;
            color: #334155;
            margin-top: 0;
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
        }
        .chart-canvas-container {
            position: relative;
            flex-grow: 1;
            min-height: 250px;
        }
        #main-chart-container {
            height: 500px;
        }
        .pictorial-container {
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            height: 100%;
        }
        .pictorial-city {
            text-align: center;
            width: 45%;
        }
        .pictorial-icons {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            justify-content: center;
            align-items: center;
            margin-top: 0.5rem;
            height: 180px;
            overflow-y: auto;
        }
        .summary-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        .city-list-modal-content {
             background-color:#fff;
             padding:2rem;
             border-radius:1rem;
             width:90%;
             max-width:400px;
             max-height:80%;
             overflow-y:auto;
        }
        .sortable-header {
            cursor: pointer;
            position: relative;
            padding-right: 20px;
        }
        .sort-icon {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            font-size: 0.8em;
        }
        .sortable-header.asc .sort-icon::before { content: '▲'; color: #1f2937; }
        .sortable-header.desc .sort-icon::before { content: '▼'; color: #1f2937; }
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
    </style>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-providers@1.13.0/leaflet-providers.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Heebo','sans-serif'] },
                    colors: {
                        'primary-green':'#34C759','light-green':'#D2F5DC','light-gray':'#F5F6F8',
                        'dark-gray':'#737373','border-gray':'#E5E7EB','teal-blue':'#4A90E2',
                        'dark-blue':'#1a202c','red-500':'#EF4444','yellow-500':'#F59E0B'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-light-gray flex flex-col min-h-screen text-right">

<!-- Loading Modal -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="text-center">
        <div class="loading-spinner-large mx-auto"></div>
        <p class="mt-4 text-white text-lg font-medium">המערכת טוענת את הנתונים המעודכנים...</p>
    </div>
</div>

<header class="app-header py-4 px-6 md:px-12 flex items-center justify-between">
  <div class="flex items-center gap-4">
    <div class="w-10 h-10 bg-primary-green text-white rounded-full flex items-center justify-center text-lg">
      <i class="fas fa-globe-americas"></i>
    </div>
    <div>
      <h2 class="text-xl font-bold text-dark-blue">רשות איכות הסביבה</h2>
      <p class="text-xs text-dark-gray">מערכת חיזוי זיהום אוויר</p>
    </div>
  </div>
  <nav class="hidden md:flex items-center gap-2">
    <a href="/main" class="nav-link text-dark-gray px-4 py-2 rounded-full transition-colors duration-300 hover:bg-light-green hover:text-primary-green"><i class="fas fa-map-marked-alt ml-2"></i>מפה ארצית</a>
    <a href="/predict" class="nav-link text-dark-gray px-4 py-2 rounded-full transition-colors duration-300 hover:bg-light-green hover:text-primary-green"><i class="fas fa-chart-line ml-2"></i>חיזוי יומי</a>
    <a href="/reports" class="nav-link active text-dark-gray px-4 py-2 rounded-full transition-colors duration-300"><i class="fas fa-file-alt ml-2"></i>דוחות</a>
  </nav>
  <div class="user-profile">
    <i class="fas fa-user-circle text-2xl text-dark-gray"></i>
  </div>
</header>

<main class="flex-grow mt-24 mb-8 container mx-auto px-4 md:px-8 lg:px-12">
  <h1 class="text-3xl font-bold text-dark-blue text-center mb-4">דוחות ניהוליים</h1>
  <p class="text-lg text-dark-gray text-center mb-12">ניתוח נתונים מתקדם ליצוא דוחות מקצועיים</p>

  <!-- Report Settings Card -->
  <div class="bg-white rounded-xl shadow-lg p-6 border border-border-gray mb-8">
    <div class="flex items-center justify-between mb-6 border-b pb-4">
      <div class="flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6V4m0 16v-2m-6-2H4m16 0h-2m-4-8h-2m0 16h2m-6 6H4m16 0h-2m-6-6h-2m-2-2v2m0-6h2m0 16v-2" />
        </svg>
        <h3 class="font-bold text-xl">הגדרות דוח</h3>
      </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <div>
        <label for="report-date-from" class="block text-sm font-medium text-dark-gray mb-1">מתאריך</label>
        <input type="date" id="report-date-from" class="w-full border border-border-gray rounded-lg py-2 px-3 text-dark-gray focus:outline-none focus:ring-2 focus:ring-teal-blue">
      </div>
      <div>
        <label for="report-date-to" class="block text-sm font-medium text-dark-gray mb-1">עד תאריך</label>
        <input type="date" id="report-date-to" class="w-full border border-border-gray rounded-lg py-2 px-3 text-dark-gray focus:outline-none focus:ring-2 focus:ring-teal-blue">
      </div>
      <div>
        <label for="report-type" class="block text-sm font-medium text-dark-gray mb-1">סוג דוח</label>
        <select id="report-type" onchange="toggleReportFilters()" class="w-full border border-border-gray rounded-lg py-2 px-3 text-dark-gray focus:outline-none focus:ring-2 focus:ring-teal-blue">
          <option value="detailed" selected>דוח מפורט</option>
          <option value="city-comparison">השוואה בין ערים</option>
          <option value="trees-aqi">כמות עצים / AQI</option>
        </select>
      </div>
    </div>

    <div id="cityComparisonFilters" class="mt-6 hidden">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div>
              <label for="filter-population" class="block text-sm font-medium text-dark-gray mb-1">אוכלוסייה</label>
              <select id="filter-population" onchange="populateCityDropdowns()" class="w-full border border-border-gray rounded-lg py-2 px-3 text-dark-gray focus:outline-none focus:ring-2 focus:ring-teal-blue">
                <option value="">הכל</option>
                <option value="low">עד 327K</option>
                <option value="medium">327K - 654K</option>
                <option value="high">מעל 654K</option>
              </select>
            </div>
            <div>
              <label for="filter-factories" class="block text-sm font-medium text-dark-gray mb-1">מפעלים</label>
              <select id="filter-factories" onchange="populateCityDropdowns()" class="w-full border border-border-gray rounded-lg py-2 px-3 text-dark-gray focus:outline-none focus:ring-2 focus:ring-teal-blue">
                <option value="">הכל</option>
                <option value="low">0-6</option>
                <option value="medium">7-12</option>
                <option value="high">13+</option>
              </select>
            </div>
            <div>
              <label for="filter-cars" class="block text-sm font-medium text-dark-gray mb-1">כלי רכב</label>
              <select id="filter-cars" onchange="populateCityDropdowns()" class="w-full border border-border-gray rounded-lg py-2 px-3 text-dark-gray focus:outline-none focus:ring-2 focus:ring-teal-blue">
                <option value="">הכל</option>
                <option value="low">עד 100K</option>
                <option value="medium">100K - 200K</option>
                <option value="high">מעל 200K</option>
              </select>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
              <label for="report-city-1" class="block text-sm font-medium text-dark-gray mb-1">עיר 1</label>
              <select id="report-city-1" class="w-full border border-border-gray rounded-lg py-2 px-3 text-dark-gray focus:outline-none focus:ring-2 focus:ring-teal-blue">
                  <option value="">בחר עיר...</option>
              </select>
          </div>
          <div>
              <label for="report-city-2" class="block text-sm font-medium text-dark-gray mb-1">עיר 2</label>
              <select id="report-city-2" class="w-full border border-border-gray rounded-lg py-2 px-3 text-dark-gray focus:outline-none focus:ring-2 focus:ring-teal-blue">
                  <option value="">בחר עיר...</option>
              </select>
          </div>
      </div>
    </div>

    <button id="showReportButton" class="w-full bg-teal-blue text-white font-medium py-3 rounded-full flex items-center justify-center shadow-lg hover:bg-teal-blue/90 transition-colors duration-300 mt-6" onclick="showReport()">
      <div id="buttonContent" class="flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
        </svg>
        <span>הצג דוח</span>
      </div>
      <div id="loadingIndicator" class="hidden loading-spinner"></div>
    </button>
  </div>

  <div id="summaryCardsSection" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 hidden">
  </div>

  <div id="detailedReportCharts" class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8 hidden">
  </div>

  <div id="comparisonChartsSection" class="bg-white rounded-xl shadow-lg p-6 border border-border-gray mb-8 hidden">
    <div class="flex items-center mb-4 border-b pb-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0h6m-6 4h6m-6-4v-4m0-6V7m0 0a2 2 0 012-2h2a2 2 0 012 2z"/></svg>
      <h3 class="font-bold text-xl">השוואת נתונים בין ערים</h3>
    </div>
    <div id="comparison-charts-container"></div>
  </div>

  <div id="detailedReportCards" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8 hidden"></div>

  <!-- Trees/AQI Report Section -->
  <div id="treesMapSection" class="bg-white rounded-xl shadow-lg p-6 border border-border-gray mb-8 hidden">
    <div class="flex items-center mb-4 border-b pb-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
      <h3 class="font-bold text-xl">מפת השפעת עצים</h3>
    </div>
    <p class="text-sm text-dark-gray mb-4">גודל האייקון מצביע על כמות העצים במקום; צבע לפי AQI.</p>
    <p id="map-display-counter" class="text-sm font-medium text-dark-gray mb-2"></p>
    <div id="treesMap" class="w-full rounded-lg relative">
        <div class="map-filter-buttons">
            <button id="show-cities-btn" class="active">ערים</button>
            <button id="show-councils-btn">מועצות אזוריות</button>
        </div>
        <div id="map-controls">
            <button id="toggle-map-view" class="bg-white p-2 rounded-lg shadow-md text-dark-gray hover:bg-gray-100 transition-colors duration-200">
            <i class="fas fa-satellite"></i>
            </button>
        </div>
    </div>
  </div>

  <div id="tableSection" class="bg-white rounded-xl shadow-lg p-6 border border-border-gray hidden">
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b pb-4">
      <div class="flex items-center mb-4 md:mb-0">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
        <h3 id="tableTitle" class="font-bold text-xl">טבלת נתונים</h3>
      </div>
      <button class="bg-teal-blue text-white px-4 py-2 rounded-full font-medium flex items-center shadow-md hover:bg-teal-blue/90 transition-colors duration-300">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
        <span>ייצוא דוח</span>
      </button>
    </div>
    <div class="table-container">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50 sticky top-0">
          <tr id="table-header-row">
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="name" onclick="sortTable('name')">שם<span class="sort-icon"></span></th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="type" onclick="sortTable('type')">סוג<span class="sort-icon"></span></th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="council" onclick="sortTable('council')">מועצה/שיוך<span class="sort-icon"></span></th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="aqi" onclick="sortTable('aqi')">AQI<span class="sort-icon"></span></th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">סטטוס</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="population" onclick="sortTable('population')">אוכלוסייה<span class="sort-icon"></span></th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="gasCars" onclick="sortTable('gasCars')">רכבים<span class="sort-icon"></span></th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="trees" onclick="sortTable('trees')">עצים<span class="sort-icon"></span></th>
          </tr>
        </thead>
        <tbody id="report-table-body" class="bg-white divide-y divide-gray-200"></tbody>
      </table>
    </div>
  </div>

  <div id="messageBox" class="message-box hidden">
    <div class="message-box-content">
      <p id="messageText" class="text-base text-gray-800"></p>
      <button onclick="hideMessageBox()" class="mt-4 px-4 py-2 bg-primary-green text-white rounded-full hover:bg-primary-green/90 transition-colors duration-300">סגור</button>
    </div>
  </div>
</main>

<div id="cityListModal" class="modal-overlay hidden">
    <div class="city-list-modal-content">
        <div class="flex justify-between items-center mb-4 pb-2 border-b">
            <h3 id="cityListModalTitle" class="text-xl font-bold"></h3>
            <button onclick="hideCityListModal()" class="text-2xl hover:text-red-500">&times;</button>
        </div>
        <ul id="cityListModalBody" class="list-disc pr-4"></ul>
    </div>
</div>

<div id="cityDetailModal" class="modal-overlay hidden">
  <div class="modal-content">
    <div class="flex items-center justify-between mb-4 pb-4 border-b">
      <h3 id="modalTitle" class="text-2xl font-bold text-dark-blue"></h3>
      <button onclick="hideCityModal()" class="text-dark-gray text-2xl hover:text-red-500 transition-colors duration-200">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body flex-grow overflow-hidden">
      <div id="modalMap" class="map-modal-container"></div>
      <div class="flex flex-col">
        <p class="text-sm font-medium text-dark-gray mb-4">מבט חטוף על המיקום</p>
        <div id="modalGallery" class="gallery-container"></div>
      </div>
    </div>
  </div>
</div>

<footer class="p-4 text-center text-sm text-dark-gray bg-white mt-8 shadow-inner">
  <p>&copy; 2025 כל הזכויות שמורות. נבנה על ידי Gemini</p>
</footer>

<script>
// ========= Data Paths =========
const DATA_PATH = 'static/data/'; // Assuming files are in the same directory for simplicity
const PLACES_FILE   = DATA_PATH + 'newdatajsonfortest.json'; // Settlements/Cities
const COUNCILS_FILE = DATA_PATH + 'moaza_centers.json';      // Council Centers

// ========= Global State =========
let allPlaces = [];
let councilsCenters = [];
let currentTableData = [];
let sortState = { key: 'name', direction: 'asc' };
let treesMap, modalMap, mapMarkersLayer;
let activeMapFilter = 'cities'; // Default filter
let activeCharts = [];
let selectedCities = { 1: null, 2: null };

// ========= AQI Utilities =========
function getAqiColor(aqi) { 
    if (aqi >= 65 && aqi <= 80) return '#34C759'; // Green - Low
    if (aqi > 55 && aqi < 65) return '#F59E0B';  // Orange - Medium
    if (aqi >= 45 && aqi <= 55) return '#EF4444'; // Red - High
    return '#9ca3af'; // Default gray
}
function getAqiStatus(aqi) { 
    if (aqi >= 65 && aqi <= 80) return 'נמוך';
    if (aqi > 55 && aqi < 65) return 'בינוני';
    if (aqi >= 45 && aqi <= 55) return 'גבוה';
    return 'לא מסווג';
}

// ========= Form/Filter Helpers =========
const chartParameters = [
  { id: 'population', name: 'אוכלוסייה', type: 'bubble' },
  { id: 'factories',  name: 'מפעלים', type: 'donut' },
  { id: 'gasCars',    name: 'כלי רכב', type: 'horizontalBar' },
  { id: 'aqi',        name: 'AQI', type: 'gauge' },
  { id: 'trees',      name: 'עצים', type: 'pictorial' },
  { id: 'height',     name: 'גובה מעל פני הים', type: 'slope' }
];

function normalizeRecord(rec) {
  return {
    name: rec.hebname,
    type: rec.type,
    council: rec.belogns || '',
    aqi: Number(rec.aqi_global) || 0,
    trees: Number(rec.trees) || 0,
    population: Number(rec.numberofpop) || 0,
    gasCars: Number(rec.cars) || 0,
    factories: Number(rec.num_fact) || 0,
    height: Number(rec.elevation) || Math.floor(Math.random() * 200), // Added height with random fallback
    lat: Number(rec.lat),
    lon: Number(rec.lan)
  };
}

async function loadData() {
  try {
    const [placesResp, councilsResp] = await Promise.all([ fetch(PLACES_FILE), fetch(COUNCILS_FILE) ]);
    if (!placesResp.ok) throw new Error(`Failed to load places file: ${placesResp.statusText}`);
    if (!councilsResp.ok) throw new Error(`Failed to load councils file: ${councilsResp.statusText}`);

    const rawPlaces = await placesResp.json();
    councilsCenters = await councilsResp.json();
    allPlaces = rawPlaces.map(normalizeRecord).filter(p => p.name && !isNaN(p.lat) && !isNaN(p.lon));

    populateCityDropdowns();
  } catch (err) {
    console.error(err);
    showMessageBox('שגיאה בטעינת הנתונים: ' + err.message + '<br>אנא ודא שקבצי ה-JSON זמינים בנתיב המוגדר.');
    document.getElementById('loadingOverlay').innerHTML = `<div class="text-center"><i class="fas fa-exclamation-triangle text-red-500 text-5xl"></i><p class="mt-4 text-white text-lg font-medium">טעינת הנתונים נכשלה</p></div>`;
  }
}

function filterCities() {
    const pop = document.getElementById('filter-population').value;
    const fac = document.getElementById('filter-factories').value;
    const cars = document.getElementById('filter-cars').value;

    return allPlaces.filter(p => {
        if (p.type !== 'עיר') return false;
        
        const popOk = (pop === '' ||
            (pop === 'low' && p.population <= 327000) ||
            (pop === 'medium' && p.population > 327000 && p.population <= 654000) ||
            (pop === 'high' && p.population > 654000));
            
        const facOk = (fac === '' ||
            (fac === 'low' && p.factories <= 6) ||
            (fac === 'medium' && p.factories >= 7 && p.factories <= 12) ||
            (fac === 'high' && p.factories >= 13));

        const carsOk = (cars === '' ||
            (cars === 'low' && p.gasCars <= 100000) ||
            (cars === 'medium' && p.gasCars > 100000 && p.gasCars <= 200000) ||
            (cars === 'high' && p.gasCars > 200000));

        return popOk && facOk && carsOk;
    });
}

function populateCityDropdowns() {
    const city1Select = document.getElementById('report-city-1');
    const city2Select = document.getElementById('report-city-2');
    const cityList = filterCities();

    const val1 = city1Select.value;
    const val2 = city2Select.value;

    city1Select.innerHTML = '<option value="">בחר עיר...</option>';
    city2Select.innerHTML = '<option value="">בחר עיר...</option>';

    cityList.forEach(city => {
        city1Select.innerHTML += `<option value="${city.name}">${city.name}</option>`;
        city2Select.innerHTML += `<option value="${city.name}">${city.name}</option>`;
    });

    city1Select.value = val1;
    city2Select.value = val2;
    
    updateDisabledOptions();
}

function updateDisabledOptions() {
    const city1Select = document.getElementById('report-city-1');
    const city2Select = document.getElementById('report-city-2');
    const val1 = city1Select.value;
    const val2 = city2Select.value;

    Array.from(city2Select.options).forEach(opt => opt.disabled = (opt.value === val1 && val1 !== ''));
    Array.from(city1Select.options).forEach(opt => opt.disabled = (opt.value === val2 && val2 !== ''));
}


// ========= Reports Logic =========
function toggleReportFilters() {
  const reportType = document.getElementById('report-type').value;
  document.getElementById('cityComparisonFilters').style.display = 'none';

  if (reportType === 'city-comparison') { 
      document.getElementById('cityComparisonFilters').style.display = 'block';
  }

  ['summaryCardsSection', 'tableSection', 'comparisonChartsSection', 'detailedReportCards', 'treesMapSection', 'detailedReportCharts']
    .forEach(id => document.getElementById(id).classList.add('hidden'));
    
  showReport();
}

async function showReport() {
  const reportType = document.getElementById('report-type').value;
  const tableBody = document.getElementById('report-table-body');
  const buttonContent = document.getElementById('buttonContent');
  const loadingIndicator = document.getElementById('loadingIndicator');

  buttonContent.classList.add('hidden');
  loadingIndicator.classList.remove('hidden');
  ['summaryCardsSection', 'tableSection', 'comparisonChartsSection', 'detailedReportCards', 'treesMapSection', 'detailedReportCharts']
    .forEach(id => document.getElementById(id).classList.add('hidden'));
  tableBody.innerHTML = '';

  await new Promise(r => setTimeout(r, 250)); 

  if (reportType === 'city-comparison') {
    const city1 = document.getElementById('report-city-1').value;
    const city2 = document.getElementById('report-city-2').value;
    if (!city1 || !city2 || city1 === city2) {
      showMessageBox('אנא בחר שתי ערים שונות כדי לבצע השוואה.');
      loadingIndicator.classList.add('hidden'); buttonContent.classList.remove('hidden'); return;
    }
    document.getElementById('comparisonChartsSection').classList.remove('hidden');
    generateComparisonCharts(city1, city2);
    document.getElementById('tableSection').classList.remove('hidden');
    document.getElementById('tableTitle').textContent = 'טבלת נתונים מפורטת';
    currentTableData = allPlaces.filter(p => p.name === city1 || p.name === city2);
    generateTableRows(currentTableData);

  } else if (reportType === 'trees-aqi') {
    document.getElementById('treesMapSection').classList.remove('hidden');
    document.getElementById('tableSection').classList.remove('hidden');
    initTreesMap();
    await updateTableForMapFilter(); 

  } else { // Detailed Report
    document.getElementById('summaryCardsSection').classList.remove('hidden');
    document.getElementById('detailedReportCharts').classList.remove('hidden');
    document.getElementById('tableSection').classList.remove('hidden');
    document.getElementById('tableTitle').textContent = 'טבלת נתונים מפורטת';
    calculateAndDisplaySummaryCards();
    generateDetailedReportCharts(); // New function for the detailed charts
    currentTableData = allPlaces;
    await generateTableRows(currentTableData);
  }

  loadingIndicator.classList.add('hidden');
  buttonContent.classList.remove('hidden');
}

function calculateAndDisplaySummaryCards() {
    const settlements = allPlaces; // Use all places, not just cities
    if (settlements.length === 0) return;

    const totalAqi = settlements.reduce((sum, item) => sum + item.aqi, 0);
    const avgAqi = totalAqi / settlements.length;

    const goodSettlements = settlements.filter(s => getAqiStatus(s.aqi) === 'נמוך');
    const moderateSettlements = settlements.filter(s => getAqiStatus(s.aqi) === 'בינוני');
    const unhealthySettlements = settlements.filter(s => getAqiStatus(s.aqi) === 'גבוה');

    const container = document.getElementById('summaryCardsSection');
    container.innerHTML = `
        <div class="bg-white rounded-xl shadow-lg p-6 border border-border-gray flex flex-col items-center justify-center text-center summary-card">
            <div class="text-4xl font-bold text-teal-blue">${avgAqi.toFixed(0)}</div>
            <p class="text-sm text-dark-gray mt-2">ממוצע AQI ארצי</p>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6 border border-border-gray flex flex-col items-center justify-center text-center summary-card cursor-pointer" onclick="showCityListModal(['${goodSettlements.map(s => s.name).join("','")}'], 'יישובים במצב טוב')">
            <div class="text-4xl font-bold text-primary-green">${goodSettlements.length}</div>
            <p class="text-sm text-dark-gray mt-2">יישובים בזיהום נמוך</p>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6 border border-border-gray flex flex-col items-center justify-center text-center summary-card cursor-pointer" onclick="showCityListModal(['${moderateSettlements.map(s => s.name).join("','")}'], 'יישובים במצב בינוני')">
            <div class="text-4xl font-bold text-yellow-500">${moderateSettlements.length}</div>
            <p class="text-sm text-dark-gray mt-2">יישובים בזיהום בינוני</p>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6 border border-border-gray flex flex-col items-center justify-center text-center summary-card cursor-pointer" onclick="showCityListModal(['${unhealthySettlements.map(s => s.name).join("','")}'], 'יישובים במצב לא בריא')">
            <div class="text-4xl font-bold text-red-500">${unhealthySettlements.length}</div>
            <p class="text-sm text-dark-gray mt-2">יישובים בזיהום גבוה</p>
        </div>
    `;
}


function showCityListModal(cities, title) {
    document.getElementById('cityListModalTitle').textContent = title;
    const body = document.getElementById('cityListModalBody');
    body.innerHTML = cities.map(city => `<li>${city}</li>`).join('');
    document.getElementById('cityListModal').classList.remove('hidden');
}

function hideCityListModal() {
    document.getElementById('cityListModal').classList.add('hidden');
}


// ========= Table Generation & Sorting =========
function sortTable(key) {
    if (sortState.key === key) {
        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
    } else {
        sortState.key = key;
        sortState.direction = 'asc';
    }

    currentTableData.sort((a, b) => {
        const valA = a[key];
        const valB = b[key];
        
        const comparison = typeof valA === 'string' ? 
            valA.localeCompare(valB, 'he') : 
            valA - valB;
            
        return sortState.direction === 'asc' ? comparison : -comparison;
    });

    updateSortIcons();
    generateTableRows(currentTableData);
}

function updateSortIcons() {
    document.querySelectorAll('.sortable-header').forEach(header => {
        header.classList.remove('asc', 'desc');
        if (header.dataset.sortKey === sortState.key) {
            header.classList.add(sortState.direction);
        }
    });
}

async function updateTableForMapFilter() {
    if (activeMapFilter === 'cities') {
        document.getElementById('tableTitle').textContent = 'טבלת נתוני ערים';
        currentTableData = allPlaces.filter(p => p.type === 'עיר');
    } else { // 'councils'
        document.getElementById('tableTitle').textContent = 'טבלת נתוני מועצות אזוריות (מסוכם)';
        currentTableData = generateCouncilSummaryData();
    }
    sortState = { key: 'name', direction: 'asc' }; // Reset sort
    updateSortIcons();
    await generateTableRows(currentTableData);
}

function generateCouncilSummaryData() {
    const byCouncil = new Map();
    allPlaces
        .filter(p => p.council && p.council.trim() !== '' && p.type !== 'עיר')
        .forEach(p => {
            const key = p.council;
            if (!byCouncil.has(key)) byCouncil.set(key, []);
            byCouncil.get(key).push(p);
        });

    return [...byCouncil.entries()].map(([name, places]) => {
        const count = places.length;
        if (count === 0) return null;
        return {
            name: name,
            type: 'מועצה אזורית',
            council: name,
            aqi: places.reduce((s, p) => s + p.aqi, 0) / count,
            population: places.reduce((s, p) => s + p.population, 0),
            gasCars: places.reduce((s, p) => s + p.gasCars, 0),
            trees: places.reduce((s, p) => s + p.trees, 0)
        };
    }).filter(Boolean);
}


async function generateTableRows(items) {
    const tbody = document.getElementById('report-table-body');
    tbody.innerHTML = '';
    const chunkSize = 100;
    let index = 0;

    function renderChunk() {
        const fragment = document.createDocumentFragment();
        const endIndex = Math.min(index + chunkSize, items.length);
        for (let i = index; i < endIndex; i++) {
            const p = items[i];
            const tr = document.createElement('tr');
            const status = getAqiStatus(p.aqi);
            const statusColor = (status === 'נמוך') ? 'text-primary-green' : (status === 'בינוני') ? 'text-yellow-500' : (status === 'גבוה') ? 'text-red-500' : 'text-gray-500';
            tr.innerHTML = `
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.name}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.type || ''}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.council || ''}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.aqi.toFixed(0)}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${statusColor}">${status}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.population.toLocaleString()}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.gasCars.toLocaleString()}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.trees.toLocaleString()}</td>
            `;
            fragment.appendChild(tr);
        }
        tbody.appendChild(fragment);
        index = endIndex;

        if (index < items.length) {
            return new Promise(resolve => setTimeout(() => resolve(renderChunk()), 0));
        } else {
            return Promise.resolve();
        }
    }
    return renderChunk();
}

// ========= Chart Generation =========
function generateDetailedReportCharts() {
    const container = document.getElementById('detailedReportCharts');
    activeCharts.forEach(chart => chart.destroy()); // Clear any previous charts
    activeCharts = [];

    // Data for Cities
    const cities = allPlaces.filter(p => p.type === 'עיר');
    const goodCities = cities.filter(c => getAqiStatus(c.aqi) === 'נמוך').length;
    const moderateCities = cities.filter(c => getAqiStatus(c.aqi) === 'בינוני').length;
    const unhealthyCities = cities.filter(c => getAqiStatus(c.aqi) === 'גבוה').length;

    // Data for Council Settlements
    const councilSettlements = allPlaces.filter(p => p.type !== 'עיר');
    const goodCouncil = councilSettlements.filter(c => getAqiStatus(c.aqi) === 'נמוך').length;
    const moderateCouncil = councilSettlements.filter(c => getAqiStatus(c.aqi) === 'בינוני').length;
    const unhealthyCouncil = councilSettlements.filter(c => getAqiStatus(c.aqi) === 'גבוה').length;

    container.innerHTML = `
        <div class="chart-card">
            <h3>סיווג AQI בערים</h3>
            <div class="chart-canvas-container">
                <canvas id="citiesAqiChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <h3>סיווג AQI ביישובי מועצות</h3>
            <div class="chart-canvas-container">
                <canvas id="councilsAqiChart"></canvas>
            </div>
        </div>
    `;

    // Render Cities Chart
    const citiesCtx = document.getElementById('citiesAqiChart').getContext('2d');
    const citiesChart = new Chart(citiesCtx, {
        type: 'doughnut',
        data: {
            labels: ['זיהום נמוך', 'זיהום בינוני', 'זיהום גבוה'],
            datasets: [{
                label: 'ערים',
                data: [goodCities, moderateCities, unhealthyCities],
                backgroundColor: ['#34C759', '#F59E0B', '#EF4444'],
                borderColor: '#eef2f5',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top' } }
        }
    });
    activeCharts.push(citiesChart);

    // Render Councils Chart
    const councilsCtx = document.getElementById('councilsAqiChart').getContext('2d');
    const councilsChart = new Chart(councilsCtx, {
        type: 'doughnut',
        data: {
            labels: ['זיהום נמוך', 'זיהום בינוני', 'זיהום גבוה'],
            datasets: [{
                label: 'יישובי מועצות',
                data: [goodCouncil, moderateCouncil, unhealthyCouncil],
                backgroundColor: ['#34C759', '#F59E0B', '#EF4444'],
                borderColor: '#eef2f5',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top' } }
        }
    });
    activeCharts.push(councilsChart);
}


function generateComparisonCharts(name1, name2) {
    const p1 = allPlaces.find(p => p.name === name1);
    const p2 = allPlaces.find(p => p.name === name2);
    const container = document.getElementById('comparison-charts-container');
    
    activeCharts.forEach(chart => chart.destroy());
    activeCharts = [];
    container.innerHTML = '';
    if (!p1 || !p2) return;

    container.innerHTML = `
        <div id="main-chart-container" class="chart-card mb-8">
            <h3>השוואה כוללת (ערכים מנורמלים)</h3>
            <div class="chart-canvas-container">
                <canvas id="radarChart"></canvas>
            </div>
        </div>
        <div id="individual-charts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
    `;

    const grid = document.getElementById('individual-charts-grid');
    const chartConfigs = [
        { id: 'population', name: 'אוכלוסייה', type: 'bubble' },
        { id: 'gasCars', name: 'כלי רכב', type: 'horizontalBar' },
        { id: 'factories', name: 'מפעלים', type: 'donut' },
        { id: 'trees', name: 'עצים', type: 'pictorial' },
        { id: 'height', name: 'גובה מעל פני הים', type: 'slope' },
        { id: 'aqi', name: 'AQI', type: 'gauge' },
    ];

    chartConfigs.forEach(param => {
        const card = document.createElement('div');
        card.className = 'chart-card';
        const canvasId = `${param.id}Chart`;
        card.innerHTML = `<h3>${param.name}</h3><div class="chart-canvas-container" id="${canvasId}-container"></div>`;
        grid.appendChild(card);
        renderIndividualChart(canvasId, param.type, p1, p2);
    });
    
    renderRadarChart(p1, p2);
}

function renderRadarChart(cityA, cityB) {
    const ctx = document.getElementById('radarChart').getContext('2d');
    const features = ['population', 'gasCars', 'factories', 'trees', 'aqi', 'height'];
    const labels = ['אוכלוסייה', 'כלי רכב', 'מפעלים', 'עצים', 'AQI', 'גובה'];

    const normalizedDataA = [];
    const normalizedDataB = [];

    features.forEach(feature => {
        const valA = cityA[feature];
        const valB = cityB[feature];
        const maxVal = Math.max(valA, valB, 1);
        
        if (feature === 'aqi') { // Lower AQI is better
            normalizedDataA.push(valA > 0 ? (1 - (valA / maxVal)) * 100 : 100);
            normalizedDataB.push(valB > 0 ? (1 - (valB / maxVal)) * 100 : 100);
        } else {
            normalizedDataA.push((valA / maxVal) * 100);
            normalizedDataB.push((valB / maxVal) * 100);
        }
    });

    const chart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{
                label: cityA.name,
                data: normalizedDataA,
                borderColor: '#34C759',
                backgroundColor: 'rgba(52, 199, 89, 0.3)',
                borderWidth: 2,
                pointBackgroundColor: '#34C759'
            }, {
                label: cityB.name,
                data: normalizedDataB,
                borderColor: '#4A90E2',
                backgroundColor: 'rgba(74, 144, 226, 0.3)',
                borderWidth: 2,
                pointBackgroundColor: '#4A90E2'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    angleLines: { color: 'rgba(0,0,0,0.1)' },
                    grid: { color: 'rgba(0,0,0,0.1)' },
                    pointLabels: { font: { size: 12 } },
                    ticks: { backdropColor: '#eef2f5' },
                    min: 0,
                    max: 100
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const feature = features[context.dataIndex];
                            const originalValue = context.dataset.label === cityA.name ? cityA[feature] : cityB[feature];
                            return `${context.dataset.label}: ${originalValue.toLocaleString()}`;
                        }
                    }
                }
            }
        }
    });
    activeCharts.push(chart);
}


function renderIndividualChart(canvasId, type, cityA, cityB) {
    const container = document.getElementById(`${canvasId}-container`);
    container.innerHTML = `<canvas id="${canvasId}"></canvas>`; // Reset container
    const ctx = document.getElementById(canvasId)?.getContext('2d');
    const feature = canvasId.replace('Chart', '');
    const v1 = cityA[feature] ?? 0;
    const v2 = cityB[feature] ?? 0;
    let chart;

    switch(type) {
        case 'bubble':
            chart = new Chart(ctx, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: cityA.name,
                        data: [{ x: 1, y: 1, r: Math.sqrt(v1) / 20 }],
                        backgroundColor: 'rgba(52, 199, 89, 0.7)'
                    }, {
                        label: cityB.name,
                        data: [{ x: 2, y: 1, r: Math.sqrt(v2) / 20 }],
                        backgroundColor: 'rgba(74, 144, 226, 0.7)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' }, tooltip: {
                    callbacks: { label: (ctx) => `${ctx.dataset.label}: ${v1.toLocaleString()}` }
                }}, scales: { x: { display: false }, y: { display: false } } }
            });
            break;
        case 'slope':
             chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [cityA.name, cityB.name],
                    datasets: [{
                        data: [v1, v2],
                        borderColor: '#64748b',
                        borderWidth: 2,
                        pointBackgroundColor: ['#34C759', '#4A90E2'],
                        pointRadius: 8,
                        pointHoverRadius: 10,
                        tension: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
            break;
        case 'pictorial':
            container.innerHTML = ''; // Clear canvas
            const pictorialContainer = document.createElement('div');
            pictorialContainer.className = 'pictorial-container';
            
            [cityB, cityA].forEach((city, index) => { // Swapped order here
                const cityDiv = document.createElement('div');
                cityDiv.className = 'pictorial-city';
                const value = city[feature];
                const color = city.name === cityA.name ? 'text-primary-green' : 'text-teal-blue';

                cityDiv.innerHTML = `<p class="font-bold">${city.name}</p><p class="text-sm">${value.toLocaleString()}</p>`;
                
                const iconsDiv = document.createElement('div');
                iconsDiv.className = 'pictorial-icons';
                
                const iconCount = Math.min(100, Math.floor(value / 1000)); // Cap at 100 icons
                for(let i = 0; i < iconCount; i++) {
                    iconsDiv.innerHTML += `<i class="fas fa-tree ${color}"></i>`;
                }
                cityDiv.appendChild(iconsDiv);
                pictorialContainer.appendChild(cityDiv);
            });
            container.appendChild(pictorialContainer);
            break;
        case 'horizontalBar':
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [cityA.name, cityB.name],
                    datasets: [{ data: [v1, v2], backgroundColor: ['#34C759', '#4A90E2'], borderRadius: 4 }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true } }, plugins: { legend: { display: false } } }
            });
            break;
        case 'donut':
            const total = v1 + v2;
            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [cityA.name, cityB.name],
                    datasets: [{ data: [v1, v2], backgroundColor: ['#34C759', '#4A90E2'], borderColor: '#eef2f5' }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    cutout: '50%', 
                    plugins: { 
                        legend: { position: 'top' }
                    }
                },
                plugins: [{
                    id: 'doughnut-center-text',
                    afterDraw: (chart) => {
                        const { ctx, chartArea: { width, height } } = chart;
                        ctx.save();
                        ctx.font = 'bold 1.5rem Heebo';
                        ctx.fillStyle = '#334155';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(total.toLocaleString(), width / 2, height / 2);
                        ctx.restore();
                    }
                }]
            });
            break;
        case 'gauge':
            const gaugeContainer = ctx.canvas.parentNode;
            gaugeContainer.innerHTML = ''; // Clear canvas for SVG
            const maxGaugeVal = 150;
            const getAngle = (val) => Math.min(180, (val / maxGaugeVal) * 180) - 90;
            const angle1 = getAngle(v1);
            const angle2 = getAngle(v2);
            gaugeContainer.innerHTML = `
                <svg class="w-full h-full" viewBox="0 0 200 120">
                    <path d="M 20 100 A 80 80 0 0 1 180 100" stroke="#EF4444" stroke-width="20" fill="none" />
                    <path d="M 20 100 A 80 80 0 0 1 100 20" stroke="#F59E0B" stroke-width="20" fill="none" />
                    <path d="M 20 100 A 80 80 0 0 1 54.6 34.6" stroke="#34C759" stroke-width="20" fill="none" />
                    <g transform="translate(100, 100) rotate(${angle1})">
                        <line x1="0" y1="0" x2="0" y2="-80" stroke="#34C759" stroke-width="3" />
                        <circle cx="0" cy="-80" r="5" fill="#34C759" />
                    </g>
                    <g transform="translate(100, 100) rotate(${angle2})">
                        <line x1="0" y1="0" x2="0" y2="-65" stroke="#4A90E2" stroke-width="3" />
                        <circle cx="0" cy="-65" r="5" fill="#4A90E2" />
                    </g>
                    <circle cx="100" cy="100" r="5" fill="white" stroke="black" stroke-width="1" />
                    <text x="20" y="112" text-anchor="middle" font-size="10">טוב</text>
                    <text x="100" y="15" text-anchor="middle" font-size="10">בינוני</text>
                    <text x="180" y="112" text-anchor="middle" font-size="10">גרוע</text>
                </svg>
                <div class="mt-2 text-xs flex justify-center gap-4">
                    <span><i class="fas fa-circle text-primary-green"></i> ${cityA.name} (${v1})</span>
                    <span><i class="fas fa-circle text-teal-blue"></i> ${cityB.name} (${v2})</span>
                </div>`;
            break;
    }
    if (chart) activeCharts.push(chart);
}


// ========= Map Logic =========
function initTreesMap() {
  if (treesMap) { 
      treesMap.invalidateSize();
  } else {
      treesMap = L.map('treesMap', { zoomControl: false }).setView([31.8, 34.8], 8);
      L.control.zoom({ position: 'bottomleft' }).addTo(treesMap);

      const street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' });
      const sat = L.tileLayer.provider('Esri.WorldImagery');
      treesMap.addLayer(sat);

      const toggleBtn = document.getElementById('toggle-map-view');
      toggleBtn.onclick = () => {
        if (treesMap.hasLayer(sat)) { treesMap.removeLayer(sat); treesMap.addLayer(street); toggleBtn.innerHTML = '<i class="fas fa-satellite-dish"></i>'; } 
        else { treesMap.removeLayer(street); treesMap.addLayer(sat); toggleBtn.innerHTML = '<i class="fas fa-satellite"></i>'; }
      };

      mapMarkersLayer = L.layerGroup().addTo(treesMap);

      document.getElementById('show-cities-btn').onclick = () => {
        activeMapFilter = 'cities';
        document.getElementById('show-cities-btn').classList.add('active');
        document.getElementById('show-councils-btn').classList.remove('active');
        renderMapMarkers();
        updateTableForMapFilter();
      };
      document.getElementById('show-councils-btn').onclick = () => {
        activeMapFilter = 'councils';
        document.getElementById('show-cities-btn').classList.remove('active');
        document.getElementById('show-councils-btn').classList.add('active');
        renderMapMarkers();
        updateTableForMapFilter();
      };
  }
  
  renderMapMarkers();
  setTimeout(() => treesMap.invalidateSize(), 100);
}

function renderMapMarkers() {
  if (!mapMarkersLayer) return;
  mapMarkersLayer.clearLayers();
  const counterElement = document.getElementById('map-display-counter');
  if (!counterElement) return;
  
  const BASE_TREE_THRESHOLD = 5000;
  const BASE_ICON_SIZE = 15;
  const MAX_ADDITIONAL_SIZE = 35; // Total max size will be 15 + 35 = 50px

  if (activeMapFilter === 'cities') {
    const citiesOnly = allPlaces.filter(p => p.type === 'עיר');
    counterElement.textContent = `מוצגות כעת ${citiesOnly.length} ערים על המפה.`;
    
    if (citiesOnly.length === 0) return;

    const treesAboveThreshold = citiesOnly.map(p => p.trees).filter(t => t > BASE_TREE_THRESHOLD);
    const maxTrees = treesAboveThreshold.length > 0 ? Math.max(...treesAboveThreshold) : BASE_TREE_THRESHOLD;

    citiesOnly.forEach(p => {
      let size;
      if (p.trees <= BASE_TREE_THRESHOLD) {
          size = BASE_ICON_SIZE;
      } else {
          const denom = (maxTrees - BASE_TREE_THRESHOLD) || 1;
          const ratio = (p.trees - BASE_TREE_THRESHOLD) / denom;
          size = BASE_ICON_SIZE + (ratio * MAX_ADDITIONAL_SIZE);
      }
      
      const aqiColor = getAqiColor(p.aqi);
      const status = getAqiStatus(p.aqi);
      const iconHtml = `<div class="tree-icon" style="font-size:${size}px;color:${aqiColor}"><i class="fas fa-tree"></i></div>`;
      const icon = L.divIcon({ html: iconHtml, className: 'no-border', iconSize: [size, size], iconAnchor: [size / 2, size] });

      L.marker([p.lat, p.lon], { icon })
        .addTo(mapMarkersLayer)
        .bindTooltip(`<b>${p.name}</b><br><b>עצים:</b> ${p.trees.toLocaleString()}<br><b>AQI:</b> ${p.aqi} <span>(${status})</span>`, { direction: 'top', sticky: true })
        .on('click', () => showCityModal(p));
    });

  } else { // 'councils' filter
    const byCouncil = new Map();
    allPlaces
        .filter(p => p.council && p.council.trim() !== '' && p.type !== 'עיר')
        .forEach(p => {
            const key = p.council;
            if (!byCouncil.has(key)) byCouncil.set(key, []);
            byCouncil.get(key).push(p);
        });

    const councilTotals = [...byCouncil.entries()].map(([name, arr]) => {
      const totalTrees = arr.reduce((s, x) => s + (x.trees || 0), 0);
      const avgAqi = arr.length ? (arr.reduce((s, x) => s + (x.aqi || 0), 0) / arr.length) : 0;
      return { name, totalTrees, avgAqi };
    });
    
    counterElement.textContent = `מוצגות כעת ${councilTotals.length} מועצות אזוריות על המפה.`;
    
    const treesAboveThreshold = councilTotals.map(c => c.totalTrees).filter(t => t > BASE_TREE_THRESHOLD);
    const maxTrees = treesAboveThreshold.length > 0 ? Math.max(...treesAboveThreshold) : BASE_TREE_THRESHOLD;

    councilTotals.forEach(ct => {
      const centerObj = councilsCenters.find(c => (c['name:he'] || c.name) === ct.name);
      if (!centerObj || !centerObj.center) return;

      let size;
      if (ct.totalTrees <= BASE_TREE_THRESHOLD) {
          size = BASE_ICON_SIZE;
      } else {
          const denom = (maxTrees - BASE_TREE_THRESHOLD) || 1;
          const ratio = (ct.totalTrees - BASE_TREE_THRESHOLD) / denom;
          size = BASE_ICON_SIZE + (ratio * MAX_ADDITIONAL_SIZE);
      }

      const aqiColor = getAqiColor(ct.avgAqi);
      const status = getAqiStatus(ct.avgAqi);
      const iconHtml = `<div class="tree-icon" style="font-size:${size}px;color:${aqiColor}"><i class="fas fa-tree"></i></div>`;
      const icon = L.divIcon({ html: iconHtml, className: 'no-border', iconSize: [size, size], iconAnchor: [size / 2, size] });
      const lat = centerObj.center.latitude, lon = centerObj.center.longitude;

      L.marker([lat, lon], { icon })
        .addTo(mapMarkersLayer)
        .bindTooltip(`<b>מועצה אזורית:</b> ${ct.name}<br><b>סה"כ עצים:</b> ${ct.totalTrees.toLocaleString()}<br><b>AQI ממוצע:</b> ${ct.avgAqi.toFixed(0)} <span>(${status})</span>`, { direction: 'top', sticky: true })
        .on('click', () => showMessageBox(`<b>מועצה אזורית: ${ct.name}</b><br>סה"כ עצים: ${ct.totalTrees.toLocaleString()}<br>AQI ממוצע: ${ct.avgAqi.toFixed(0)} (${status})`));
    });
  }
}

// ========= Modal Logic =========
function showCityModal(p) {
  const modal = document.getElementById('cityDetailModal');
  document.getElementById('modalTitle').textContent = `נתונים מפורטים עבור ${p.name}`;
  modal.classList.remove('hidden');

  if (modalMap) { modalMap.remove(); }
  modalMap = L.map('modalMap').setView([p.lat, p.lon], 13);
  L.tileLayer.provider('Esri.WorldImagery').addTo(modalMap);
  L.marker([p.lat, p.lon]).addTo(modalMap).bindPopup(`<b>${p.name}</b>`).openPopup();

  const gallery = document.getElementById('modalGallery');
  gallery.innerHTML = '';
  for (let i = 0; i < 24; i++) {
    const imgUrl = `https://placehold.co/100x100/004d40/ffffff?text=${encodeURIComponent(p.name)}`;
    gallery.innerHTML += `<img src="${imgUrl}" alt="צילום ${p.name}">`;
  }
  setTimeout(() => modalMap.invalidateSize(), 100);
}
function hideCityModal() { document.getElementById('cityDetailModal').classList.add('hidden'); }

// ========= Message Box =========
function showMessageBox(message) {
  document.getElementById('messageText').innerHTML = message;
  document.getElementById('messageBox').classList.remove('hidden');
}
function hideMessageBox() { document.getElementById('messageBox').classList.add('hidden'); }

// ========= Onload / Initialization =========
window.onload = async function() {
  document.getElementById('report-type').addEventListener('change', toggleReportFilters);
  
  await loadData(); // Load JSON data first
  
  // Default to detailed report view
  document.getElementById('report-type').value = 'detailed';
  toggleReportFilters();
  await showReport(); // Make sure this completes
  
  document.getElementById('loadingOverlay').classList.add('hidden'); // Hide modal after data is loaded and rendered
};
</script>
</body>
</html>
